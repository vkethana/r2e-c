#SKIP =  ['openresty___luajit2', 'jpmens___jo', 'kgabis___parson', 'armon___bloomd', 'wiseman___py-webrtcvad', 'antirez___linenoise', 'sustrik___libmill', 'mit-pdos___xv6-public', 'yarrick___iodine', 'rui314___8cc', 'fukuchi___libqrencode', 'janmojzis___tinyssh', 'nanomsg___nanomsg', 'patjak___bcwc_pcie', 'bartobri___no-more-secrets', 'antirez___disque', 'tmikolov___word2vec', 'nicolasff___webdis', 'tpruvot___ccminer', 'spacemeowx2___switch-lan-play', 'stefansundin___altdrag', 'tjko___jpegoptim', 'signalapp___libsignal-protocol-c', 'sustrik___libdill', 'vermaseren___form', 'marcobambini___gravity', 'grimfang4___sdl-gpu', 'begeekmyfriend___bplustree', 'cmusphinx___pocketsphinx', 'zauonlok___renderer', 'hacksysteam___hacksysextremevulnerabledriver', 'huangz1990___annotated_redis_source', 'zpl-c___librg', 'fogleman___craft', 'yasm___yasm', 'jgarff___rpi_ws281x', 'julius-speech___julius', 'orangeduck___mpc', 'luadist___lua', 'edenhill___kafkacat', 'danginsburg___opengles3-book', 'ckolivas___cgminer', 'abrasive___shairport', 'gsliepen___tinc', 'mozilla___mozjpeg', 't6x___reaver-wps-fork-t6x', 'scannet___scannet', 'tpruvot___cpuminer-multi', 'libevent___libevent', 'ultrajson___ultrajson', 'ambrop72___badvpn', 'lexbor___lexbor', 'thewover___donut', 'netflix___dynomite', 'session-replay-tools___tcpcopy', 'huangz1990___redis-3.0-annotated', 'jedisct1___minisign', 'lzfse___lzfse']
#SKIP.extend(['irungentoo___toxcore', 'chentao0707___qrcodescan', 'coolwanglu___vim.js', 'antirez___hping', 'amadvance___snapraid', 'stanfordnlp___glove', 'cisco___joy', 'stichting-minix-research-foundation___minix', 'yourtion___30daymakeos', 'jkornev___hidden', 'justinfrankel___licecap', 'kn007___silk-v3-decoder', 'koush___superuser', 'signal11___hidapi', 'leixiaohua1020___simplest_ffmpeg_mobile', 'zmap___zmap', 'alibaba___lvs', 'danielgtaylor___jpeg-archive', 'kangjianwei___data-structure', 'rewardone___oscprepo', 'yangchaojiang___yjplay', 'jp9000___obs', 'krakjoe___parallel', 'mabeijianxi___small-video-record', 'akopytov___sysbench', 'maratyszcza___nnpack', 'kbengine___kbengine', 'dlundquist___sniproxy', 'olimex___olinuxino', 'rubinius___rubinius', 'seclab-ucr___intang', 'cisco-talos___pyrebox', 'zedshaw___learn-c-the-hard-way-lectures', 'teamwin___team-win-recovery-project', 'shellinabox___shellinabox', 'secwiki___windows-kernel-exploits', 'achimdoebler___ugui', 'cundong___smartappupdates', 'secwiki___linux-kernel-exploits', 'fancycode___memorymodule', 'google___eddystone', 'vishnubob___python-midi', 'iliasam___opensimplelidar', 'mongrel2___mongrel2', 'julycoding___the-art-of-programming-by-july', 'mbebenita___broadway', 'shadowsocks___chinadns', 'attractivechaos___klib', 'rsms___markdown-wasm', 'xroche___httrack', 'kornelski___pngquant', 'proxmark___proxmark3', 'matz___streem', 'googlecreativelab___anypixel', 'apple___homekitadk', 'kevinlawler___kona', 'klange___nyancat', 'orangeduck___corange', 'tuanpmt___esp_mqtt', 'hnes___libaco', 'fix94___nintendont', 'termux___termux-x11', 'libimobiledevice___ideviceinstaller', 'iolanguage___io', 'wishstudio___flinux', 'aergoio___litetree', 'apple___darwin-xnu', 'go-gl___glfw', 'ngs-lang___ngs', 'loyinglin___learnopengles', 'sp4cerat___fast-quadric-mesh-simplification', 'neurobin___shc', 'id-software___quake-2', 'nkolban___esp32-snippets', 'bingoogolapple___bgaqrcode-android', 'yaoweibin___nginx_tcp_proxy_module', 'addy-dclxvi___almighty-dotfiles', 'vurtun___nuklear', 'agavrel___42_cheatsheet', 'nfc-tools___libnfc', 'fragglet___c-algorithms', 'openglredbook___examples', 'awesome-harmonyos___harmonyos', 'twitter___ios-twitter-image-pipeline', 'isometimes___rpi4-osdev', 'hfiref0x___syscalltables', 'blindmindstudios___starruler2-source', 'telegrammessenger___mtproxy', 'mofarrell___p2pvc', 'baskerville___sxhkd', 'dmajkic___redis', 'chiakge___linux-netspeed', 'mpenkov___ffmpeg-tutorial', 'minoca___os', 'allalgorithms___c', 'wine-mirror___wine', 'dekunukem___nintendo_switch_reverse_engineering', 'cleanflight___cleanflight', 'bztsrc___raspi3-tutorial', 'hashcat___hashcat-legacy', 'vlfeat___vlfeat', 'fossasia___pslab-bootloader', 'bugaevc___wl-clipboard', 'vanhoefm___krackattacks-scripts', 'linux-noah___noah', 's-macke___sam', 'corellium___projectsandcastle', 'facebookarchive___libphenom', 'saminiir___level-ip', 'squeaky-pl___japronto', 'imbushuo___mac-precision-touchpad', 'mcnopper___opengl', 'grahamdumpleton___mod_wsgi', 'lmdb___lmdb', 'pervognsen___bitwise', 'orangeduck___cello', 'cmatsuoka___figlet', 'openkinect___libfreenect', 'id-software___quake-iii-arena', 'valdikss___goodbyedpi', 'tomojitakasu___rtklib', 'conorpp___u2f-zero', 'cfenollosa___os-tutorial', 'linw7___skill-tree', 'quiet___org.quietmodem.quiet', 'ioi___isolate', 'torch___torch7', 'pellepl___spiffs', 'openresty___headers-more-nginx-module', 'chenyahui___annotatedcode', 'binbyu___reader', 'galkahana___hummusjs', 'tcurdt___iproxy', 'cloudwu___pbc', 'doctorwkt___acwj', 'christinaa___rpi-open-firmware', 'pytorch___qnnpack', 'cnlohr___espusb', 'wuxx___nanodap', 'hishamhm___htop', 'udp___json-parser', 'nuand___bladerf', 'rdesktop___rdesktop', 'christophejacquet___pifmrds', 'wizteam___wizqtclient', 'kdlucas___byte-unixbench', 'olikraus___u8glib', 'samypesse___how-to-make-a-computer-operating-system', 'mtcp-stack___mtcp', 'unpbook___unpv13e', 'x64dbg___gleebug', 'wireguard___wireguard-monolithic-historical', 'flame___how-to-optimize-gemm', 'sparklemotion___nokogiri', 'juhovh___shairplay', 'pipelinedb___pipelinedb', 'mntmn___interim', 'dtrace4linux___linux', 'torvalds___uemacs', 'ming1016___study', 'antirez___sds', 'guanshuicheng___invoice', 'whitecatboard___lua-rtos-esp32', 'jiangdongguo___androidusbcamera', 'tanersener___mobile-ffmpeg', 'mykter___afl-training', 'sunzxyong___tiny', 'getdnsapi___stubby', 'theofficialflow___adrenaline', 'jerryscript-project___iotjs', 'msysgit___msysgit', 'armink___sfud', 'madler___pigz', 'schismtracker___schismtracker', 'antimof___uxplay', 'riba2534___tcp-ip-networknote', 'samyk___pwnat', 'adrianlopezroche___fdupes', 'saghul___pyuv', 'ionescu007___simplevisor', 'traviscross___mtr', 'frickle___ngx_cache_purge', 'libfuse___sshfs', 'twitter___fatcache', 's-march___smarchwatch_public', 'kiukotsu___ucore', '0voice___algorithm-structure', 'spotify___sparkey', 'irtimmer___moonlight-embedded', 'armink___easyflash', 'pgaudit___pgaudit', '0x90___wifi-arsenal', 'nodejs___http-parser', 'tmate-io___tmate', 'abcminiuser___lufa', 'blinker-iot___blinker-esp-idf', 'projectne10___ne10', 'joedog___siege', 'teaonly___android-eye', 'dav___word2vec', 'lavabit___magma', 'nmikhailov___validity90', 'atomicobject___heatshrink', 'cx9208___bbrplus', 'snavely___bundler_sfm', 'karlstav___cava', 'nicholas3388___luanode', 'alibaba___tsar', 'jhawthorn___fzy', 'mpc-hc___mpc-hc', 'f5oeo___rpitx', 'pwmt___zathura', 'drh___lcc', 'anestisb___vdexextractor', 'nikhilm___uvbook', 'facebookresearch___darkforestgo', 'evanw___thinscript', 'gsass1___ntop', 'liexusong___php-beast', 'woai3c___mit6.828', 'sandboxie___sandboxie', 'google___google-authenticator-libpam', 'netsniff-ng___netsniff-ng', 'bumptech___stud', 'sqfmi___watchy', 'white-tiger___t-clock', 'jart___sectorlisp', 'yodaos-project___yodaos', 'zavg___linux-0.01', 'maxbube___mydumper', 'dekunukem___daytripper', 'a0rtega___pafish', 'networkprotocol___netcode', 'pelya___android-keyboard-gadget', 'bootchk___resynthesizer'])

import os
import subprocess
import logging
from pathlib import Path
from paths import REPOS_DIR

# Configure logger
log_file = 'codeql_analysis.log'
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(log_file),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger()

# Counters and lists for successes and failures
total_success = 0
total_failures = 0
success_repos = []
failure_repos = []

# Iterate over all repositories in REPOS_DIR
for repo_name in os.listdir(REPOS_DIR):
    repo_path = Path(REPOS_DIR) / repo_name
    '''
    if repo_name in SKIP:
        logger.info(f"Skipping {repo_name}")
        continue
    '''

    if repo_path.is_dir():
        logger.info(f"Processing repository: {repo_name}")

        # Run the CodeQL database creation command
        cmd = ['/home/vkethana/codeql/codeql', 'database', 'create', 'my-database', '--language=cpp', '--overwrite']
        try:
            result = subprocess.run(cmd, cwd=repo_path, capture_output=True, text=True)

            # Output result of the CodeQL command
            if result.returncode == 0:
                logger.info(f"SUCCESS: {repo_name}\n{result.stdout}")
                total_success += 1
                success_repos.append(repo_name)
            else:
                logger.error(f"FAILED: {repo_name}\n{result.stderr}")
                total_failures += 1
                failure_repos.append(repo_name)

        except Exception as e:
            logger.error(f"Error running CodeQL for {repo_name}: {str(e)}")
            total_failures += 1
            failure_repos.append(repo_name)

        # Print running totals after each iteration
        logger.info(f"Running totals: Successes: {total_success}, Failures: {total_failures}")
        logger.info(f"Success repos: {success_repos}")
        logger.info(f"Failed repos: {failure_repos}")

# Final summary
logger.info("Script completed.")
logger.info(f"Total successes: {total_success}")
logger.info(f"Total failures: {total_failures}")
logger.info(f"Repos that succeeded: {success_repos}")
logger.info(f"Repos that failed: {failure_repos}")



